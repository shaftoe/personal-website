{{- $id := printf "%s/%s" .Section .File.ContentBaseName -}}
{{- $sectionData := (index .Site.Data.comments .Section) -}}

{{ with (index $sectionData .File.ContentBaseName) }}
<h4>{{ len . }} comment{{ if gt (len .) 1 }}s{{ end }}</h4>
    <ol>
    {{ range . }}
    {{- $commentId := printf "comment-%s" ._id }}
        <li id="{{ $commentId }}">
            {{ if not (eq .email "") }}
            <img
                src="https://www.gravatar.com/avatar/{{ .email }}"
                alt="Gravatar profile image for commenter named '{{ .name }}'"
                class="avatar"
            >
            {{- end -}}

            <h5>{{ .name | htmlEscape }}</h5>

            <small class="date">
                <a
                    href="{{ .RelPermalink }}#{{ $commentId }}"
                    title="Permanent link to {{ .name }}'s comment"
                >
                    {{ partial "date" .date }}
                </a>
            </small>

            <div>
                {{ .body | markdownify }}
            </div>
        </li>
    {{- end -}}
    </ol>
{{- end -}}

<h4>Leave a comment</h4>
<form method="POST" action="{{ .Param "staticmanUrl" }}">
    <textarea name="fields[body]" placeholder="New Comment! Feel free to use Markdown." rows="6" required></textarea>
    <input type="hidden" name="options[redirect]" value="{{ .Permalink }}#comment-submitted">
    <input type="hidden" name="options[entryId]" value="{{ $id }}">
    <div class="input">
        <input name="fields[name]" type="text" placeholder="Your name" required>
        <input name="fields[email]" type="email" placeholder="Gravatar email * (optional)">
        <input type="submit" value="Post Comment">
    </div>
    <small class="email">* email hashed with MD5, i.e. never stored nor displayed in clear text</small>
</form>